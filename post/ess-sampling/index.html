<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="generator" content="Hugo 0.21" />
    <link rel="stylesheet" type="text/css" href="../../css/fonts.css">
    <link rel="stylesheet" type="text/css" href="../../css/style.css">
    <link rel="stylesheet" type="text/css" href="../../css/lovelace.css">
    
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({
        tex2jax: {
          inlineMath: [['$','$'], ['\\(','\\)']],
          displayMath: [['$$','$$'], ['\[','\]']],
          processEscapes: true,
          processEnvironments: true,
          skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
          TeX: { equationNumbers: { autoNumber: "AMS" },
               extensions: ["AMSmath.js", "AMSsymbols.js"] }
        }
      });
    </script>
    <script type="text/javascript" async
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
    </script>
  </head>
  <body>
    <nav id="navbar">
      <a href="http://tpapp.github.io/">About</a>
      <a href="http://tpapp.github.io/research">Research</a>
      <a href="http://tpapp.github.io/post">Blog</a>
      <a href="http://tpapp.github.io/software">Software</a>

      <a href="https://github.com/tpapp/">Github</a>
    </nav>

    <div id="content">


<h1>Sampling variation in effective sample size estimates (MCMC)</h1>2017/06/12
<span class="tags">
    
    <a href="../../tags/mcmc">MCMC</a>
    
    <a href="../../tags/bayesian">Bayesian</a>
    
    <a href="../../tags/julia">julia</a>
    
</span>





<h2 id="introduction">Introduction</h2>

<p>MCMC samples, used in Bayesian statistics, are not independent &mdash; in fact, unless one uses specialized methods or <a href="https://arxiv.org/abs/1701.02434">modern HMC</a>, posterior draws are usually at highly autocorrelated. For independent draws,
[
\text{variance of simulation mean} \propto \frac1N
]
where $N$ is the sample size, but for correlated draws, one has to scale the sample size with a factor
[
\tau = \frac{1}{1+2\sum_{k=1}^\infty \rho_k}
]
where $\rho_k$ is the lag-$k$ autocorrelation. $\tau N$ is the <em>effective sample size</em>.</p>

<p>Usually, $\rho_k$ is estimated from the data using the variogram
[
V_k = \frac{1}{N-k} \sum_{i=1}^{N-k} x_i x_{i+k}
]
from which we obtain
[
\rho_k = 1-\frac{V_k}{2\text{var}(x)}
]
where an estimator for the variance is also used. Then, to avoid using noisy estimates, we only add up to the last $K$ where
[
\rho_{K} + \rho_{K+1} \ge 0
]
I will call $K$ the <em>last lag</em>. <a href="http://mc-stan.org/">Stan</a> does something slightly different, using FFT for autocorrelations, and cutting off at the first negative $\rho_K$, but for HMC this does not make a whole lot of difference.</p>

<h2 id="the-sampling-variation">The sampling variation</h2>

<p>I was coding up the above calculation, and needed some unit tests. Surprisignly, I could not find anything on the sampling variation of $\tau$, so I wrote some simulations in Julia (<a href="https://gist.github.com/tpapp/c1d5d267a8dcc4c9278de6a101622cdc">source code for everything</a>). I did the following simulation exercise:</p>

<ol>
<li>for a given autocorrelation coefficient $\phi$, simulate $N$ draws from the AR(1) process
[
x_t = \phi x_{t-1} + \sigma \epsilon_t
\qquad
\epsilon_t \sim \text{Normal}(0,1), \text{IID}
]</li>
<li>calculate $\tau$ and $K$,</li>
<li>repeat 1000 times and plot the results.</li>
</ol>

<p>I use $N=1000$ and $N=10000$, as these would be typical sample sizes, first for a fairly efficient algorithm, then for a more stubborn but still manageable posterior.</p>

<h2 id="iid-samples">IID samples</h2>

<p>Let $\phi=0$, then we expect $\tau=1$ (red line in histogram, coefficient of variation on top).</p>

<p>
<figure >
    
        <img src="../figures/ess-phi0N1000.svg" />
    
    
    <figcaption>
        <h4>Results with $\phi=0$ (IID), $N=1000$. (a) $\tau$, (b) last lag $K$, (c) scatterplot.</h4>
        
    </figcaption>
    
</figure>


<figure >
    
        <img src="../figures/ess-phi0N10000.svg" />
    
    
    <figcaption>
        <h4>Results with $\phi=0$ (IID), $N=10000$. (a) $\tau$, (b) last lag $K$, (c) scatterplot.</h4>
        
    </figcaption>
    
</figure>
</p>

<p>With $1000$ samples, there is a lot of variation in ESS: 800 could show up very easily in practice. $600$ is not improbable either. Using up to $10$ lags is not uncommon.</p>

<p>For $10000$ samples, the precision is improved considerably, we commonly use $2$ or $4$ lags.</p>

<p>For both sample sizes, notice the high correlation between the last lag $K$, and $\tau$: given the method above, using more lags increases $\tau^{-1}$, so this is to be expected.</p>

<h2 id="ar-1-samples-with-rho-0-5">AR(1) samples with $\rho=0.5$</h2>

<p>This is a more autocorrelated process, here theory tells us that $\tau$=<sup>1</sup>&frasl;<sub>3</sub>.</p>

<p>
<figure >
    
        <img src="../figures/ess-phi05N1000.svg" />
    
    
    <figcaption>
        <h4>Results with $\phi=0.5$, $N=1000$. (a) $\tau$, (b) last lag $K$, (c) scatterplot.</h4>
        
    </figcaption>
    
</figure>


<figure >
    
        <img src="../figures/ess-phi05N10000.svg" />
    
    
    <figcaption>
        <h4>Results with $\phi=0.5$, $N=10000$. (a) $\tau$, (b) last lag $K$, (c) scatterplot.</h4>
        
    </figcaption>
    
</figure>
</p>

<p>Notice that $\tau$ is now more dispersed, compared to the IID case. Even with 10000 samples, the coefficient of variation is 6%, with 1000 it is around <sup>1</sup>&frasl;<sub>6</sub>. In practice, expect effective sample sizes all over the place.</p>

<h2 id="ar-1-samples-with-rho-0-8">AR(1) samples with $\rho=0.8$</h2>

<p>This is an even more autocorrelated process, here theory tells us that $\tau$=<sup>1</sup>&frasl;<sub>9</sub>.</p>

<p>
<figure >
    
        <img src="../figures/ess-phi08N1000.svg" />
    
    
    <figcaption>
        <h4>Results with $\phi=0.8$, $N=1000$. (a) $\tau$, (b) last lag $K$, (c) scatterplot.</h4>
        
    </figcaption>
    
</figure>


<figure >
    
        <img src="../figures/ess-phi08N10000.svg" />
    
    
    <figcaption>
        <h4>Results with $\phi=0.8$, $N=10000$. (a) $\tau$, (b) last lag $K$, (c) scatterplot.</h4>
        
    </figcaption>
    
</figure>
</p>

<p>There is now so much variation that in order to get an estimate for ESS that we can use for comparing various MCMC implementations, we need to run much more than $1000$ samples.</p>

<h2 id="conclusion">Conclusion</h2>

<ol>
<li><p>For unit testing ESS calculations, I will need to use 10000 samples, with $\pm10$ or similar error bands.</p></li>

<li><p>As a rule of thumb, I would ignore less than 1.5x variation in ESS for 1000 samples, or run longer chains: it may be just random noise.</p></li>
</ol>

<h2 id="bibliography">Bibliography</h2>

<ul>
<li>Gelman, Andrew, et al. 2013. Bayesian data analysis. 3rd edition. Chapman &amp; Hall/CRC.</li>
<li>Stan Development Team. 2016. Stan Modeling Language Users Guide and Reference Manual, Version 2.15.0. <a href="http://mc-stan.org">http://mc-stan.org</a></li>
</ul>



<div id="pagenav">
  
  <span class="pagenav-label">Previous</span>
  <a href="http://tpapp.github.io/post/blog-redesign/">Blog redesign</a>
  
  
</div>

<div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_shortname = 'tpappgithubio';
    var disqus_identifier = 'http:\/\/tpapp.github.io\/post\/ess-sampling\/';
    var disqus_title = 'Sampling variation in effective sample size estimates (MCMC)';
    var disqus_url = 'http:\/\/tpapp.github.io\/post\/ess-sampling\/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    </div>
    <div id="sidebar">
      
      <a href="../../tags/bayesian">bayesian</a>
      
      <a href="../../tags/blogging">blogging</a>
      
      <a href="../../tags/browser-plugins">browser-plugins</a>
      
      <a href="../../tags/economics">economics</a>
      
      <a href="../../tags/firefox">firefox</a>
      
      <a href="../../tags/hugo">hugo</a>
      
      <a href="../../tags/jacobian">jacobian</a>
      
      <a href="../../tags/julia">julia</a>
      
      <a href="../../tags/latex">latex</a>
      
      <a href="../../tags/math">math</a>
      
      <a href="../../tags/mcmc">mcmc</a>
      
      <a href="../../tags/my-packages">my-packages</a>
      
      <a href="../../tags/numerical-methods">numerical-methods</a>
      
      <a href="../../tags/stan">stan</a>
      
      <a href="../../tags/teaching">teaching</a>
      
      <a href="../../tags/tutorial">tutorial</a>
      
      <a href="../../tags/weave">weave</a>
      
    </div>
  </body>
</html>

